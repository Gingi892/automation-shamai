# Ralph Loop Progress - Gov.il MCP Server

## Learnings (Read This First)

### ScraperAPI Settings (CRITICAL)
- Gov.il requires `ultra_premium=true` - premium alone returns 500 errors
- Must use `wait_for=5000` for Angular to render
- Always use `render=true`

### Decision Title Regex
```javascript
/הכרעת שמאי מכריע מיום (\d{2}-\d{2}-\d{4}) בעניין ([^נ]+)נ ([^ג]+)ג (\d+) ח (\d+)\s*-?\s*(.+)?/
```

### PDF URLs
- Format: `https://free-justice.openapi.gov.il/free/moj/portal/rest/searchpredefinedapi/v1/SearchPredefinedApi/Documents/DecisiveAppraiser/{docId}`
- NO .pdf extension needed

### Database
- Use sql.js (pure JS) - NOT better-sqlite3 (native bindings fail on Node 24+)
- Database already has schema created in database.ts
- Methods added: getDecision(), getDbPath(), getDistinctValues()

### Existing Code Status
- scraper.ts: Has ScraperAPI with ultra_premium and wait_for settings
- database.ts: Working with sql.js, has all required methods
- index.ts: Full MCP server with all tools defined
- types.ts: Complete type definitions

---

## Iteration Log

## Iteration 1 — US-001: Index All Decisions (VERIFIED COMPLETE)
- **What was done:** Verified all 8 acceptance criteria for US-001 are already fully implemented
- **Files verified:**
  - `src/scraper.ts` - Pagination via `?skip=N` (lines 424-427, 433), ScraperAPI settings (lines 415-416), Hebrew regex (lines 238-239, 923)
  - `src/database.ts` - content_hash deduplication (lines 176, 219)
  - `src/indexer.ts` - Progress saving/resume (lines 119-124, 277), pagination handling (lines 136-157)
  - `package.json` - `npm run index-all` script (line 11)
  - `scripts/index-all.ts` - Full indexing orchestration
- **Learnings for next cycles:**
  - US-001 was already implemented before this iteration began
  - The codebase has a robust multi-strategy fallback system for scraping
  - TypeScript type check passes cleanly
---

## Iteration 2 — US-002: Search Decisions (VERIFIED COMPLETE)
- **What was done:** Verified all 3 acceptance criteria for US-002 are already fully implemented
- **Files verified:**
  - `src/index.ts` - MCP tool `search_decisions` defined (lines 82-189) with all parameters
  - `src/index.ts` - Handler `handleSearchDecisions` (lines 786-844)
  - `src/database.ts` - `search()` method (lines 284-376) implementing all filters
- **Parameters verified:** query, committee, block, plot, appraiser, caseType, fromDate, toDate, limit, offset
- **Learnings for next cycles:**
  - US-002 was already implemented before this iteration began
  - The search uses LIKE for text matching since sql.js doesn't support FTS5
  - Results include totalCount, hasMore for pagination
---

## Iteration 3 — US-003: Read PDF Content (VERIFIED COMPLETE)
- **What was done:** Verified all 6 acceptance criteria for US-003 are already fully implemented
- **Files verified:**
  - `src/index.ts` - MCP tool `read_pdf` with `id` parameter (lines 274-311), handler (lines 928-1019)
  - `src/pdf-extractor.ts` - Complete PDF extraction module with:
    - ScraperAPI integration (lines 210-269)
    - pdf-parse for text extraction (line 287)
    - Hebrew RTL text processing (lines 154-173)
    - Database caching support (lines 329-362)
  - `src/database.ts` - `pdf_text` column (line 83), `savePdfText()` method (line 565)
- **Learnings for next cycles:**
  - Extensive Hebrew RTL handling: final letter normalization, directional control removal
  - PDF caching uses decision ID as key
  - Estimates page count from cached text length (~3000 chars/page)
---
