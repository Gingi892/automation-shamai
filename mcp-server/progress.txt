# Ralph Loop Progress - Gov.il MCP Server

## Learnings (Read This First)

### ScraperAPI Settings (CRITICAL)
- Gov.il requires `ultra_premium=true` - premium alone returns 500 errors
- Must use `wait_for=5000` for Angular to render
- Always use `render=true`

### Decision Title Regex
```javascript
/הכרעת שמאי מכריע מיום (\d{2}-\d{2}-\d{4}) בעניין ([^נ]+)נ ([^ג]+)ג (\d+) ח (\d+)\s*-?\s*(.+)?/
```

### PDF URLs
- Format: `https://free-justice.openapi.gov.il/free/moj/portal/rest/searchpredefinedapi/v1/SearchPredefinedApi/Documents/DecisiveAppraiser/{docId}`
- NO .pdf extension needed

### Database
- Use sql.js (pure JS) - NOT better-sqlite3 (native bindings fail on Node 24+)
- Database already has schema created in database.ts
- Methods added: getDecision(), getDbPath(), getDistinctValues()

### Existing Code Status
- scraper.ts: Has ScraperAPI with ultra_premium and wait_for settings
- database.ts: Working with sql.js, has all required methods
- index.ts: Full MCP server with all tools defined
- types.ts: Complete type definitions

---

## Iteration Log

## Iteration 1 — US-001: Index All Decisions (VERIFIED COMPLETE)
- **What was done:** Verified all 8 acceptance criteria for US-001 are already fully implemented
- **Files verified:**
  - `src/scraper.ts` - Pagination via `?skip=N` (lines 424-427, 433), ScraperAPI settings (lines 415-416), Hebrew regex (lines 238-239, 923)
  - `src/database.ts` - content_hash deduplication (lines 176, 219)
  - `src/indexer.ts` - Progress saving/resume (lines 119-124, 277), pagination handling (lines 136-157)
  - `package.json` - `npm run index-all` script (line 11)
  - `scripts/index-all.ts` - Full indexing orchestration
- **Learnings for next cycles:**
  - US-001 was already implemented before this iteration began
  - The codebase has a robust multi-strategy fallback system for scraping
  - TypeScript type check passes cleanly
---

## Iteration 2 — US-002: Search Decisions (VERIFIED COMPLETE)
- **What was done:** Verified all 3 acceptance criteria for US-002 are already fully implemented
- **Files verified:**
  - `src/index.ts` - MCP tool `search_decisions` defined (lines 82-189) with all parameters
  - `src/index.ts` - Handler `handleSearchDecisions` (lines 786-844)
  - `src/database.ts` - `search()` method (lines 284-376) implementing all filters
- **Parameters verified:** query, committee, block, plot, appraiser, caseType, fromDate, toDate, limit, offset
- **Learnings for next cycles:**
  - US-002 was already implemented before this iteration began
  - The search uses LIKE for text matching since sql.js doesn't support FTS5
  - Results include totalCount, hasMore for pagination
---

## Iteration 3 — US-003: Read PDF Content (VERIFIED COMPLETE)
- **What was done:** Verified all 6 acceptance criteria for US-003 are already fully implemented
- **Files verified:**
  - `src/index.ts` - MCP tool `read_pdf` with `id` parameter (lines 274-311), handler (lines 928-1019)
  - `src/pdf-extractor.ts` - Complete PDF extraction module with:
    - ScraperAPI integration (lines 210-269)
    - pdf-parse for text extraction (line 287)
    - Hebrew RTL text processing (lines 154-173)
    - Database caching support (lines 329-362)
  - `src/database.ts` - `pdf_text` column (line 83), `savePdfText()` method (line 565)
- **Learnings for next cycles:**
  - Extensive Hebrew RTL handling: final letter normalization, directional control removal
  - PDF caching uses decision ID as key
  - Estimates page count from cached text length (~3000 chars/page)
---

## Iteration 4 — US-004: Get Statistics (IMPLEMENTED)
- **What was done:** Enhanced `getStats()` to return all required statistics
- **Files modified:**
  - `src/database.ts` - Extended `getStats()` method to include:
    - `byCommittee` (top 20 committees with counts)
    - `byCaseType` (all case types with counts)
    - `byYear` (yearly breakdown, extracted from decision_date)
    - `newestDecision` (date range max)
  - `src/index.ts` - Updated `handleGetStatistics()` to return new fields:
    - `byCommittee`, `byCaseType`, `byYear`, `dateRange` object
- **Technical notes:**
  - Date format is DD-MM-YYYY, year extracted via `substr(decision_date, 7, 4)`
  - byCommittee limited to top 20, sorted by count DESC
  - TypeScript type check passes
- **Learnings for next cycles:**
  - Used SQL GROUP BY with ORDER BY for efficient aggregations
  - Extended stats type defined inline to avoid touching types.ts
---

## Iteration 5 — US-005: List Committees (IMPLEMENTED)
- **What was done:** Updated `list_committees` to return decision counts with each committee
- **Files modified:**
  - `src/database.ts` - Added `getDistinctValuesWithCounts()` method that returns `{name, count}` objects sorted alphabetically
  - `src/index.ts` - Updated `handleListCommittees()` to use new method
- **Technical notes:**
  - Uses GROUP BY with ORDER BY for alphabetical sorting
  - Returns array of `{name: string, count: number}` objects
  - TypeScript type check passes
- **Learnings for next cycles:**
  - Added new method instead of modifying existing `getDistinctValues` for backwards compatibility
---

## Iteration 6 — US-006: Analytics Queries (IMPLEMENTED)
- **What was done:** Implemented `get_analytics` MCP tool with 5 query types
- **Files modified:**
  - `src/database.ts` - Added 5 analytics methods:
    - `getDecisionsByCommittee()` - count per committee, sorted by count DESC
    - `getDecisionsByYear()` - count per year, sorted by year DESC
    - `getDecisionsByAppraiser()` - count per appraiser, sorted by count DESC
    - `getDecisionsByCaseType()` - count per case type, sorted by count DESC
    - `getAvgDecisionsPerMonth()` - calculates average from total/months
  - `src/index.ts` - Added:
    - Tool definition with `query_type` enum and parameters
    - `handleGetAnalytics()` handler with switch for all query types
    - Added case to switch statement
- **Technical notes:**
  - All methods support optional database filter
  - Year extracted from DD-MM-YYYY format via substr(decision_date, 7, 4)
  - Monthly average uses COUNT(DISTINCT month) for unique months
  - TypeScript type check passes
- **Learnings for next cycles:**
  - AnalyticsQueryType defined as type literal for type safety
  - Handler returns different structures for avg_decisions_per_month vs other queries
---

## Iteration 7 — US-007: Incremental Updates (VERIFIED COMPLETE)
- **What was done:** Verified all 4 acceptance criteria for US-007 are already fully implemented
- **Files verified:**
  - `scripts/daily-update.ts` - Complete incremental update script:
    - Default 5 pages per database (line 22)
    - Calls indexer.updateRecent() (line 79)
  - `src/indexer.ts` - `updateRecent()` method (lines 194-238):
    - Iterates first N pages
    - Uses existsByHash for deduplication (line 210)
    - Only inserts new decisions
  - `src/database.ts` - `existsByHash()` method (line 215)
  - `package.json` - `npm run daily-update` script (line 12)
- **Learnings for next cycles:**
  - The indexer's updateRecent method stops early if no new documents found (line 220)
  - Updates `last_update` metadata after completion
---
