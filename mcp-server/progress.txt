# Ralph Loop Progress - Gov.il MCP Server

## Learnings (Read This First)

### ScraperAPI Settings (CRITICAL)
- Gov.il requires `ultra_premium=true` - premium alone returns 500 errors
- Must use `wait_for=5000` for Angular to render
- Always use `render=true`

### Decision Title Regex
```javascript
/הכרעת שמאי מכריע מיום (\d{2}-\d{2}-\d{4}) בעניין ([^נ]+)נ ([^ג]+)ג (\d+) ח (\d+)\s*-?\s*(.+)?/
```

### PDF URLs
- Format: `https://free-justice.openapi.gov.il/free/moj/portal/rest/searchpredefinedapi/v1/SearchPredefinedApi/Documents/DecisiveAppraiser/{docId}`
- NO .pdf extension needed

### Database
- Use sql.js (pure JS) - NOT better-sqlite3 (native bindings fail on Node 24+)
- Database already has schema created in database.ts
- Methods added: getDecision(), getDbPath(), getDistinctValues()

### Existing Code Status
- scraper.ts: Has ScraperAPI with ultra_premium and wait_for settings
- database.ts: Working with sql.js, has all required methods
- index.ts: Full MCP server with all tools defined
- types.ts: Complete type definitions

---

## Iteration Log

## Iteration 1 — US-001: Index All Decisions (VERIFIED COMPLETE)
- **What was done:** Verified all 8 acceptance criteria for US-001 are already fully implemented
- **Files verified:**
  - `src/scraper.ts` - Pagination via `?skip=N` (lines 424-427, 433), ScraperAPI settings (lines 415-416), Hebrew regex (lines 238-239, 923)
  - `src/database.ts` - content_hash deduplication (lines 176, 219)
  - `src/indexer.ts` - Progress saving/resume (lines 119-124, 277), pagination handling (lines 136-157)
  - `package.json` - `npm run index-all` script (line 11)
  - `scripts/index-all.ts` - Full indexing orchestration
- **Learnings for next cycles:**
  - US-001 was already implemented before this iteration began
  - The codebase has a robust multi-strategy fallback system for scraping
  - TypeScript type check passes cleanly
---

## Iteration 2 — US-002: Search Decisions (VERIFIED COMPLETE)
- **What was done:** Verified all 3 acceptance criteria for US-002 are already fully implemented
- **Files verified:**
  - `src/index.ts` - MCP tool `search_decisions` defined (lines 82-189) with all parameters
  - `src/index.ts` - Handler `handleSearchDecisions` (lines 786-844)
  - `src/database.ts` - `search()` method (lines 284-376) implementing all filters
- **Parameters verified:** query, committee, block, plot, appraiser, caseType, fromDate, toDate, limit, offset
- **Learnings for next cycles:**
  - US-002 was already implemented before this iteration began
  - The search uses LIKE for text matching since sql.js doesn't support FTS5
  - Results include totalCount, hasMore for pagination
---

## Iteration 3 — US-003: Read PDF Content (VERIFIED COMPLETE)
- **What was done:** Verified all 6 acceptance criteria for US-003 are already fully implemented
- **Files verified:**
  - `src/index.ts` - MCP tool `read_pdf` with `id` parameter (lines 274-311), handler (lines 928-1019)
  - `src/pdf-extractor.ts` - Complete PDF extraction module with:
    - ScraperAPI integration (lines 210-269)
    - pdf-parse for text extraction (line 287)
    - Hebrew RTL text processing (lines 154-173)
    - Database caching support (lines 329-362)
  - `src/database.ts` - `pdf_text` column (line 83), `savePdfText()` method (line 565)
- **Learnings for next cycles:**
  - Extensive Hebrew RTL handling: final letter normalization, directional control removal
  - PDF caching uses decision ID as key
  - Estimates page count from cached text length (~3000 chars/page)
---

## Iteration 4 — US-004: Get Statistics (IMPLEMENTED)
- **What was done:** Enhanced `getStats()` to return all required statistics
- **Files modified:**
  - `src/database.ts` - Extended `getStats()` method to include:
    - `byCommittee` (top 20 committees with counts)
    - `byCaseType` (all case types with counts)
    - `byYear` (yearly breakdown, extracted from decision_date)
    - `newestDecision` (date range max)
  - `src/index.ts` - Updated `handleGetStatistics()` to return new fields:
    - `byCommittee`, `byCaseType`, `byYear`, `dateRange` object
- **Technical notes:**
  - Date format is DD-MM-YYYY, year extracted via `substr(decision_date, 7, 4)`
  - byCommittee limited to top 20, sorted by count DESC
  - TypeScript type check passes
- **Learnings for next cycles:**
  - Used SQL GROUP BY with ORDER BY for efficient aggregations
  - Extended stats type defined inline to avoid touching types.ts
---

## Iteration 5 — US-005: List Committees (IMPLEMENTED)
- **What was done:** Updated `list_committees` to return decision counts with each committee
- **Files modified:**
  - `src/database.ts` - Added `getDistinctValuesWithCounts()` method that returns `{name, count}` objects sorted alphabetically
  - `src/index.ts` - Updated `handleListCommittees()` to use new method
- **Technical notes:**
  - Uses GROUP BY with ORDER BY for alphabetical sorting
  - Returns array of `{name: string, count: number}` objects
  - TypeScript type check passes
- **Learnings for next cycles:**
  - Added new method instead of modifying existing `getDistinctValues` for backwards compatibility
---

## Iteration 6 — US-006: Analytics Queries (IMPLEMENTED)
- **What was done:** Implemented `get_analytics` MCP tool with 5 query types
- **Files modified:**
  - `src/database.ts` - Added 5 analytics methods:
    - `getDecisionsByCommittee()` - count per committee, sorted by count DESC
    - `getDecisionsByYear()` - count per year, sorted by year DESC
    - `getDecisionsByAppraiser()` - count per appraiser, sorted by count DESC
    - `getDecisionsByCaseType()` - count per case type, sorted by count DESC
    - `getAvgDecisionsPerMonth()` - calculates average from total/months
  - `src/index.ts` - Added:
    - Tool definition with `query_type` enum and parameters
    - `handleGetAnalytics()` handler with switch for all query types
    - Added case to switch statement
- **Technical notes:**
  - All methods support optional database filter
  - Year extracted from DD-MM-YYYY format via substr(decision_date, 7, 4)
  - Monthly average uses COUNT(DISTINCT month) for unique months
  - TypeScript type check passes
- **Learnings for next cycles:**
  - AnalyticsQueryType defined as type literal for type safety
  - Handler returns different structures for avg_decisions_per_month vs other queries
---

## Iteration 7 — US-007: Incremental Updates (VERIFIED COMPLETE)
- **What was done:** Verified all 4 acceptance criteria for US-007 are already fully implemented
- **Files verified:**
  - `scripts/daily-update.ts` - Complete incremental update script:
    - Default 5 pages per database (line 22)
    - Calls indexer.updateRecent() (line 79)
  - `src/indexer.ts` - `updateRecent()` method (lines 194-238):
    - Iterates first N pages
    - Uses existsByHash for deduplication (line 210)
    - Only inserts new decisions
  - `src/database.ts` - `existsByHash()` method (line 215)
  - `package.json` - `npm run daily-update` script (line 12)
- **Learnings for next cycles:**
  - The indexer's updateRecent method stops early if no new documents found (line 220)
  - Updates `last_update` metadata after completion
---

## Iteration 8 — US-PDF-010: Add Pinecone Client (IMPLEMENTED)
- **What was done:** Implemented Pinecone client to connect MCP server to the 20K indexed documents
- **Files created:**
  - `src/pinecone-client.ts` - Complete PineconeClient class with:
    - Constructor with PINECONE_API_KEY and PINECONE_INDEX_HOST env vars
    - `query(embedding, topK, namespace)` method for semantic search
    - `fetchById(id, namespace)` method for direct document lookup
    - `getStats(namespace)` method for namespace statistics
    - Singleton pattern via `getPineconeClient()`
- **Package changes:**
  - Installed `@pinecone-database/pinecone` package
- **Technical notes:**
  - Uses PINECONE_INDEX_HOST (not INDEX_NAME) as the PRD was updated during implementation
  - Default namespace: 'gov-il-decisions'
  - Returns PineconeQueryResult with id, score, and metadata fields
  - TypeScript compiles cleanly
- **Learnings for next cycles:**
  - Pinecone SDK v3+ uses `index(host)` pattern with the full index host URL
  - Metadata types need to be cast from RecordMetadata to specific interface
---

## Iteration 9 — US-PDF-011: Generate Query Embeddings (IMPLEMENTED)
- **What was done:** Added OpenAI embedding generation function to embeddings.ts
- **Files modified:**
  - `src/embeddings.ts` - Added `generateQueryEmbedding(text: string): Promise<number[]>` function:
    - Uses OpenAI API `text-embedding-3-small` model
    - Generates 1024-dimension embeddings to match Python indexer
    - Requires `OPENAI_API_KEY` environment variable
    - Includes error handling for API failures and missing API key
- **Technical notes:**
  - Uses native fetch API (Node 18+)
  - Returns typed response with proper error messages
  - Function is exported for use by semantic_search handler
  - TypeScript compiles cleanly
- **Learnings for next cycles:**
  - The function name is `generateQueryEmbedding` (not `generateEmbedding` as in PRD)
  - This function will be used in US-PDF-012 to update handleSemanticSearch
---

## Iteration 10 — US-PDF-012: Update semantic_search to use Pinecone (IMPLEMENTED)
- **What was done:** Modified `handleSemanticSearch()` to use Pinecone for semantic search
- **Files modified:**
  - `src/index.ts` - Complete rewrite of `handleSemanticSearch()`:
    - Added imports for `generateQueryEmbedding` and `getPineconeClient`
    - Uses `getPineconeClient()` to get Pinecone singleton
    - Generates query embedding using `generateQueryEmbedding()` (OpenAI text-embedding-3-small)
    - Queries Pinecone with `pinecone.query(embedding, topK)`
    - Filters results by database if specified
    - Maps PineconeQueryResult to Decision format with all fields
    - Returns `source: 'pinecone'` in response to indicate search backend
    - Graceful fallback to keyword search if Pinecone fails or is unavailable
- **Technical notes:**
  - Uses Pinecone metadata fields: title, url, block, plot, committee, appraiser, case_type, decision_date, database
  - Year extracted from decision_date (format DD-MM-YYYY, substring 6-10)
  - relevanceScore comes from Pinecone's similarity score
  - Falls back to EmbeddingsManager.search() if Pinecone unavailable
  - TypeScript compiles cleanly
- **Learnings for next cycles:**
  - Response now includes `source` field to indicate which backend was used
  - Next task US-PDF-013 will update read_pdf to work with Pinecone results
---

## Iteration 11 — US-PDF-013: Update read_pdf for Pinecone Results (IMPLEMENTED)
- **What was done:** Updated `handleReadPdf()` to work with decisions from Pinecone when not found in SQLite
- **Files modified:**
  - `src/index.ts` - Rewrote `handleReadPdf()`:
    - First tries to find decision in SQLite database (for backwards compatibility)
    - Falls back to Pinecone `fetchById()` if not found in SQLite
    - Uses URL from Pinecone metadata when decision comes from Pinecone
    - Added `source` field to response ('sqlite' or 'pinecone')
    - Added `database` field to response
    - Handles case where database is null (db optional for Pinecone-only lookups)
    - Caching still works via pdfExtractor (if db is available)
- **Technical notes:**
  - Decision lookup order: SQLite first, then Pinecone
  - Pinecone uses `fetchById()` method from pinecone-client.ts
  - Response includes `source` field to indicate data origin
  - TypeScript compiles cleanly
- **Learnings for next cycles:**
  - The PdfExtractor accepts optional database, so caching works when available
  - Next task is US-PDF-003: Create PdfCache module for local file caching
---

## Iteration 12 — US-PDF-003: Create PdfCache Module (IMPLEMENTED)
- **What was done:** Created local file cache module for PDFs at `~/.gov-il-mcp/pdfs/`
- **Files created:**
  - `src/pdf-cache.ts` - Complete PdfCache class with:
    - Constructor creates cache directories for all 3 databases
    - `isCached(decisionId, database): boolean` - Check if PDF is cached
    - `loadPdf(decisionId, database): Promise<Buffer | null>` - Load cached PDF
    - `savePdf(decisionId, database, buffer): Promise<CachedPdfInfo>` - Save PDF with hash
    - `getStats(): Promise<CacheStats>` - Get cache statistics by database
    - `deletePdf(decisionId, database): Promise<boolean>` - Delete cached PDF
    - `cleanup(maxSizeBytes): Promise<number>` - LRU cache cleanup (default 5GB)
    - `formatStats(stats): string` - Human-readable stats output
    - `getPdfCache()` singleton accessor
- **Technical notes:**
  - PDFs stored in `~/.gov-il-mcp/pdfs/{database}/{id}.pdf`
  - Uses SHA-256 hash for file integrity verification
  - LRU cleanup strategy based on file modification time
  - Directories created automatically on initialization
  - TypeScript compiles cleanly
- **Learnings for next cycles:**
  - Next task is US-PDF-004: Integrate file cache into pdf-extractor
  - The PdfCache module is independent and ready to be integrated
---

## Iteration 13 — US-PDF-004: Integrate File Cache into pdf-extractor (IMPLEMENTED)
- **What was done:** Integrated PdfCache into pdf-extractor for three-tier caching
- **Files modified:**
  - `src/pdf-extractor.ts`:
    - Added imports for `PdfCache` and `DatabaseType`
    - Updated `PdfExtractorOptions` interface to accept optional `pdfCache` parameter
    - Added `pdfCache` private property to `PdfExtractor` class
    - Added `setPdfCache(pdfCache: PdfCache)` setter method
    - Rewrote `extractWithCache()` with three-tier cache strategy:
      1. Text cache (SQLite) - instant return of extracted text
      2. File cache (local files) - extract from cached PDF file
      3. Network download (ScraperAPI) - download, cache, and extract
    - Updated `smartExtract()` to accept optional `databaseType` parameter
  - `src/index.ts`:
    - Added import for `getPdfCache` from pdf-cache module
    - Updated `handleReadPdf()` to:
      - Pass `pdfCache: getPdfCache()` to `createPdfExtractor`
      - Determine `databaseType` from decision metadata
      - Pass `databaseType` to `smartExtract()` for file cache organization
- **Technical notes:**
  - Three-tier cache flow: text cache → file cache → network download
  - File cache stores PDFs in `~/.gov-il-mcp/pdfs/{database}/{id}.pdf`
  - When loading from file cache, text is also saved to text cache for faster future access
  - When downloading from network, PDF is saved to file cache first, then text extracted and cached
  - Default databaseType is 'decisive_appraiser' if not specified
  - TypeScript compiles cleanly
- **Learnings for next cycles:**
  - Next task is US-PDF-005: Add pdf_cache tracking table
  - The three-tier cache is now fully operational
---

## Iteration 14 — US-PDF-005: Add pdf_cache Tracking Table (IMPLEMENTED)
- **What was done:** Added pdf_cache SQLite table and methods for tracking cached PDF files
- **Files modified:**
  - `src/database.ts`:
    - Added `pdf_cache` table to `createSchema()` with columns:
      - `decision_id TEXT PRIMARY KEY` - Links to decision
      - `file_path TEXT NOT NULL` - Path to cached PDF file
      - `file_size INTEGER NOT NULL` - File size in bytes
      - `file_hash TEXT NOT NULL` - SHA-256 hash for integrity
      - `cached_at TEXT` - Timestamp when cached
      - `last_accessed TEXT` - Timestamp of last access (for LRU)
      - `extraction_status TEXT DEFAULT 'pending'` - Status: pending/extracted/failed
    - Added index `idx_pdf_cache_status` on `extraction_status` for filtering
    - Added `getPdfCacheStats()` method returning:
      - `totalCached` - Number of cached files
      - `totalSize` - Total bytes cached
      - `byStatus` - Breakdown by extraction status
      - `oldestEntry` / `newestEntry` - Cache date range
    - Added helper methods:
      - `recordPdfCache()` - Record a new cache entry
      - `getPdfCacheEntry()` - Get cache info for a decision
      - `touchPdfCache()` - Update last_accessed timestamp
      - `updatePdfCacheStatus()` - Update extraction status
      - `deletePdfCacheEntry()` - Remove cache entry
      - `getLruPdfCacheEntries()` - Get LRU entries for cleanup
- **Technical notes:**
  - Table uses decision_id as PRIMARY KEY for 1:1 relationship with decisions
  - last_accessed enables LRU cache cleanup strategy
  - extraction_status allows filtering for re-extraction needs
  - TypeScript compiles cleanly
- **Learnings for next cycles:**
  - Next task is US-PDF-006: Add cache management tools
  - The pdf_cache table is ready to be used by PdfCache module
---
