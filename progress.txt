# Progress Log

## Learnings
(Notes discovered during implementation)

### Pre-Implementation Research (2026-01-20)

**Gov.il Site Structure:**
- All three databases use AngularJS with client-side rendering
- Dynamic content loaded via `ng-controller="dynamicCtrl"`
- Pagination: `?skip=N` parameter (10 items per page)
- PDF URLs pattern: `https://free-justice.openapi.gov.il/...`
- Search autocomplete: `https://searchgov.gov.il/govil/Suggestext/`

**Existing Code Issues (from QA-FINDINGS.md):**
- 19 issues identified, 3 CRITICAL
- ALL CSS selectors are outdated
- Tool name mismatch: README says `search_land_decisions`, code has `search_decisions`
- Non-existent `search_and_read` tool documented but not implemented
- Angular wait timeout too short (2s fallback)
- No filter success verification

**Working Components:**
- SQLite database layer (`mcp-server/src/database.ts`) - GOOD
- Type definitions (`mcp-server/src/types.ts`) - GOOD
- Indexer logic (`mcp-server/src/indexer.ts`) - GOOD
- Basic MCP server structure (`mcp-server/src/index.ts`) - GOOD

**Broken Components:**
- Scraper selectors (`mcp-server/src/scraper.ts`) - BROKEN
- Puppeteer flow (`mcp-server-live/src/`) - BROKEN

**Key Design Decisions:**
1. Keep SQLite + FTS5 approach (proven to work)
2. Rebuild scraper with multiple fallback strategies
3. Add selector health check before full crawl
4. Improve tool descriptions with Hebrew examples
5. Add query clarification tool for ambiguous queries

---

## Iteration 1 — US-001 Task 1: ScraperAPI render/premium configuration
- **What was done**: Verified existing implementation in scraper.ts already uses `render=true` and `premium=true` as defaults
- **Files affected**: None (already implemented in `mcp-server/src/scraper.ts` lines 32-33 and 40-45)
- **Validation**: TypeScript type check passes (`npx tsc --noEmit` succeeds)
- **Learnings for next cycles**:
  - Patterns: ScraperAPI URL built via `URLSearchParams` with api_key, url, render, premium params
  - Patterns: `buildScraperUrl()` method centralizes URL construction
  - Helpful context: The scraper defaults to premium=true and render=true via nullish coalescing (`??`)

---

## Iteration 2 — US-001 Task 2: Multiple selector strategies with fallbacks
- **What was done**: Implemented multi-strategy fallback system for resilient HTML parsing
- **Files affected**: `mcp-server/src/scraper.ts` (major refactor of parseDecisions method)
- **Validation**: TypeScript type check passes (`npx tsc --noEmit` succeeds)
- **Implementation details**:
  - Added `SelectorStrategyType` type: 'css_primary' | 'css_structural' | 'regex_fallback'
  - Created `SelectorConfig` interface with configurable selectors for each strategy
  - Implemented `DEFAULT_SELECTORS` constant with:
    - Primary selectors: class-based (e.g., `.dynamic-card`, `.result-item`)
    - Structural selectors: tag/attribute-based (e.g., `div[ng-repeat]`, `article`)
    - Regex patterns: raw HTML extraction (e.g., `/הכרעת שמאי[^<\n]{10,200}/g`)
  - Strategy tracking: `lastStrategyUsed`, `strategyStats` map
  - Helper methods: `getLastStrategyUsed()`, `getStrategyStats()`, `logStrategy()`
  - Refactored `parseDecisions()` to call strategies in order and log warnings on fallback
- **Learnings for next cycles**:
  - Patterns: Cheerio CheerioAPI type for $ parameter in helper methods
  - Patterns: Use `cheerio.Cheerio<cheerio.Element>` for element wrappers
  - Traps: Regex patterns must be reset (use `g` flag) or create new instances per match
  - Traps: HTML capture groups need cleaning with `.replace(/<[^>]*>/g, '')`
  - Helpful context: Logging to stderr (not stdout) preserves MCP stdio protocol

---

## Iteration 4 — US-001 Task 4: Parse HTML with Cheerio using adaptive patterns
- **What was done**: Verified existing implementation of adaptive Cheerio parsing with three extraction strategies
- **Files affected**: `mcp-server/src/scraper.ts` (already implemented in iteration 2, marking as complete)
- **Validation**: TypeScript type check passes (`npx tsc --noEmit` succeeds)
- **Implementation details**:
  - `parseWithCssPrimary()` (lines 299-350): Uses class-based selectors like `.dynamic-card`, `.result-item`
  - `parseWithCssStructural()` (lines 355-375): Uses tag/attribute-based selectors like `div[ng-repeat]`, `article`
  - `parseWithRegex()` (lines 380-442): Uses regex patterns for raw HTML extraction
  - `parseDecisions()` (lines 260-294): Orchestrates all three strategies with automatic fallback
  - Warning logs when primary selectors fail but fallback succeeds (line 275, 285)
- **Learnings for next cycles**:
  - Patterns: Code implemented in iteration 2 covered multiple acceptance criteria
  - Patterns: Check existing implementation before assuming work is needed
  - Helpful context: DEFAULT_SELECTORS constant (lines 79-160) contains all selector configurations

---

## Iteration 3 — US-001 Task 3: Selector health check before full crawl
- **What was done**: Implemented `checkSelectorHealth()` and `checkAllSelectorHealth()` methods to validate selectors against live pages before starting a full crawl
- **Files affected**: `mcp-server/src/scraper.ts`
- **Validation**: TypeScript type check passes (`npx tsc --noEmit` succeeds)
- **Implementation details**:
  - Added `SelectorHealthResult` interface with: database, healthy, timestamp, strategies map, recommendedStrategy, warnings array, optional error
  - `checkSelectorHealth(database)` fetches first page and tests all 3 strategies independently
  - Returns which strategies are working, recommended strategy, and warnings for degradation
  - `checkAllSelectorHealth()` iterates all 3 databases with rate limiting
  - Logs health check progress to stderr
  - Warnings generated for: primary selector failure, low item count (<5), all strategies failing
- **Learnings for next cycles**:
  - Patterns: Health checks should test all strategies independently, not short-circuit
  - Patterns: Return recommended strategy to guide crawl behavior
  - Patterns: Include timestamp in health results for staleness tracking
  - Helpful context: Expected ~10 items per page based on gov.il pagination
